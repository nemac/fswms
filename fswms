#! /usr/bin/python

import re, os, sys, subprocess
import pystache as p

def usage():
    print "usage: fswms COMMAND [ARG ...]"
    print "   where COMMAND is one of: 'list', 'create', 'delete', 'deploy'"
    exit(-1)

def standardize_version_tag(tag):
    # Return a copy of the string `tag` with the prefix `fswms-` prepended to it,
    # unless `tag` already starts with that prefix, in which case it is returned
    # unaltered.
    if tag.startswith("fswms-"):
        return tag
    else:
        return "fswms-" + tag

def system(cmd):
    #print cmd
    return os.system(cmd)

def compare_versions(a,b):
    try:
        [amajor,aminor] = [int(x) for x in a.split('.')]
        [bmajor,bminor] = [int(x) for x in b.split('.')]
    except:
        if a < b:
            return -1
        elif a > b:
            return 1
        else:
            return 0
    if amajor < bmajor:
        return -1
    elif amajor > bmajor:
        return 1
    else:
        if aminor < bminor:
            return -1
        elif aminor > bminor:
            return 1
    return 0

def tag_list():
    return sorted([re.sub(r'^fswms-(.*)$',r'\1',x) for x in
                   subprocess.Popen(['git', 'tag'], stdout=subprocess.PIPE).communicate()[0].split('\n') if x != ''], cmp=compare_versions)

def tag_exists(tag):
    tag = re.sub(r'^fswms-', '', tag)
    for t in tag_list():
        if t == tag:
            return True
    return False

def dist(tag):
    # This function creates a gzipped tar file in the top level directory, containing a copy of
    # fswms corresponding to the named tag.  The name of the tar file will be the tag followed
    # by the suffix ".tgz".
    #
    # This function works by exporting the named tag from the current project's repository
    # in ./.git.  Therefore, the named tag must already exist in that repo.
    os.system("/bin/rm -rf .stage")
    stagedir = p.render('.stage/{{{tag}}}', {'tag' : tag})
    os.makedirs(stagedir)
    status = os.system(p.render("(git archive --format=tar {{{tag}}} | (cd {{{stagedir}}} ; tar xf -)) > /dev/null 2>&1",
                                { 'tag'      : tag,
                                  'stagedir' : stagedir}))
    if status != 0:
        print "Cannot export tag %s" % tag
        sys.exit(-1)
    f = open(stagedir + "/version", "w")
    f.write(p.render("""#! /usr/bin/python
#
# This script prints out the version number of this copy of fswms.
# This script was autogenerated by the command `fswms dist {{{tag}}}`.
print "{{{tag}}}"
"""
    , { 'tag' : tag }))
    f.close()
    os.system(p.render("chmod +x {{{stagedir}}}/version", { 'stagedir' : stagedir }))
    distfile = tag + ".tgz"
    os.system(p.render("(cd .stage ; tar cfz - {{{tag}}}) > {{{distfile}}}",
                       { 'tag'      : tag,
                         'distfile' : distfile}))
    os.system("/bin/rm -rf .stage")
    return distfile


def validate_deploy_dst(dst):
    if not os.path.exists(dst):
        return False
    if not os.path.exists(dst + "/var/Config.py"):
        return False
    sys.path.append(dst + "/var")
    import Config
    if os.stat(dst).st_ino != os.stat(Config.BASE_DIR).st_ino:
        return False
    if os.stat(dst + "/var/Config.py").st_ino != os.stat(Config.BASE_DIR + "/var/Config.py").st_ino:
        return False
    return True
    
def deploy(tag, dst):
    # make sure deploy dst is valid
    if not validate_deploy_dst(dst):
        print "Directory `%s` does not appear to be a valid fswms deployment destination" % dst
        sys.exit(-1)
    print "extracting %s..." % tag
    tgzfile = dist(tag)
    # make sure tgzfile is really there
    if not os.path.exists(tgzfile):
        print "Archive file %s does not exist." % tgzfile
        sys.exit(-1)
    # unpack tgzfile into staging dir:
    system("/bin/rm -rf .stage")
    os.mkdir(".stage")
    system(p.render("cat {{{tgzfile}}} | ( cd .stage ; tar xfz - )", { 'tgzfile' : tgzfile }))
    # remove all files from dst except 'var' subdir:
    print "cleaning old files from %s..." % dst
    for f in [f for f in os.listdir(dst) if f != 'var']:
        system(p.render("/bin/rm -rf {{{dst}}}/{{{f}}}",
                           { 'dst' : dst,
                             'f'   : f }))
    # copy everything from the staging directory to the dst:
    print "copying %s files to %s..." % (tag, dst)
    system(p.render("(cd .stage/{{{tag}}} ; tar cf - .) | (cd {{{dst}}} ; tar xf -)",
                       { 'tag' : tag,
                         'dst' : dst }))
    # run fscron in newly deploy dst dir:
    print "running fscron in %s..." % dst
    system(p.render("cd {{{dst}}}/msconfig ; ./fscron", { 'dst' : dst }))
    # clean up staging dir
    print "cleaning up..."
    os.unlink(tgzfile)
    system("/bin/rm -rf .stage")
    print "finished deploying %s to %s" % (tag, dst)

if __name__ == "__main__":
    try:
        command = sys.argv[1]
    except:
        usage()

    if command == "list":
        print ("The versions of fswms currently defined in the git repository are: %s" % ", ".join(tag_list()))
        sys.exit(0)

    if command == "dist":
        try:
            tag = standardize_version_tag(sys.argv[2])
        except:
            print "usage: fswms dist TAG"
            sys.exit(-1)
        tag = standardize_version_tag(sys.argv[2])
        os.system("git checkout master")
        os.system("git pull origin master")
        distfile = dist(tag)
        print "Wrote `" + distfile + "`"
        sys.exit(0)

    if command == "deploy":
        try:
            tag = standardize_version_tag(sys.argv[2])
            dst = re.sub(r'/$', '', sys.argv[3]) # be sure to remove any trailing '/' from dst dir
        except:
            print "usage: fswms deploy TAG DESTINATION-DIRECTORY"
            sys.exit(-1)
        deploy(tag, dst)
        sys.exit(0)


    if command == "create":
        try:
            tag = standardize_version_tag(sys.argv[2])
        except:
            print "usage: fswms create TAG"
            sys.exit(-1)
        if tag_exists(tag):
            print "Error: The tag '%s' already exists." % tag
            sys.exit(-1)
        os.system("git checkout master")
        os.system("git pull origin master")
        os.system(p.render("git tag -a -m 'create tag {{{tag}}}' {{{tag}}}", { 'tag' : tag }))
        os.system("git push origin master")
        os.system("git push origin %s" % tag)
        print "created %s " % (tag)
        sys.exit(-1)

    if command == "delete":
        try:
            tag = standardize_version_tag(sys.argv[2])
        except:
            print "usage: fswms delete TAG"
            sys.exit(-1)
        if not tag_exists(tag):
            print "Error: The tag '%s' does not exist." % tag
            sys.exit(-1)
        os.system("git checkout master")
        os.system("git pull origin master")
        os.system(p.render("git tag -d {{{tag}}}", { 'tag' : tag }))
        os.system(p.render("git push origin :refs/tags/{{{tag}}}", { 'tag' : tag }))
        print "deleted %s " % (tag)
        sys.exit(-1)

    usage()
